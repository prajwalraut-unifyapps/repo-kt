{
	"appsUsed":[
		
	],
	"createdTime":1751956607125,
	"deleted":false,
	"deploymentState":{
		"deployedAt":1752833833391,
		"deployedBy":39715,
		"deployedDefinitionId":"687a1f296457a08e20138b13",
		"status":"DEPLOYED",
		"version":3,
		"workflowVersion":39
	},
	"edges":[
		{
			"fromNodeId":"n_cDeDe",
			"priority":0,
			"skip":false,
			"toNodeId":"n_Lj2kG",
			"type":"next"
		},
		{
			"fromNodeId":"n_Lj2kG",
			"priority":0,
			"skip":false,
			"toNodeId":"n_AvNAu",
			"type":"next"
		}
	],
	"id":"686cbc7f0c4a812a9406cd0f",
	"lastModifiedBy":103171,
	"lcName":"[virtu-fusion-jwt-token-create-fn] jwttokenfromemail",
	"modifiedTime":1759005280396,
	"name":"[virtu-fusion-jwt-token-create-fn] jwtTokenFromEmail",
	"nodes":[
		{
			"additional":{
				"xsdSchemaConfig":{
					"root":{}
				}
			},
			"context":{
				"appName":"callables",
				"resourceVersion":786,
				"resourceName":"callables_from_automation"
			},
			"debug":false,
			"dirty":false,
			"fallbackMode":"STOP",
			"groupId":"_UX8oT-1",
			"id":"n_cDeDe",
			"index":1,
			"inputs":{
				"result":{
					"type":"object",
					"properties":{
						"result":{
							"type":"string",
							"title":"Result"
						}
					},
					"additionalProperties":false,
					"required":[
						"result"
					]
				},
				"setup":{
					"type":"object",
					"properties":{
						"email":{
							"type":"string",
							"title":"Email"
						},
						"AADToken":{
							"type":"string",
							"title":"AAD Token"
						}
					},
					"additionalProperties":false,
					"required":[
						"email",
						"AADToken"
					]
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Trigger via automation",
			"trigger":{
				"type":"CALLABLE"
			},
			"type":"START"
		},
		{
			"context":{
				"appName":"code_by_unifyapps",
				"resourceVersion":761,
				"resourceName":"code_by_unifyapps_python",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":false,
			"fallbackMode":"STOP",
			"groupId":"_UX8oT-1",
			"id":"n_Lj2kG",
			"index":2,
			"inputs":{
				"output":{
					"type":"object",
					"properties":{
						"result":{
							"type":"string",
							"title":"Result"
						}
					},
					"additionalProperties":false,
					"required":[
						"result"
					]
				},
				"configurationMode":"MANUAL",
				"input":{
					"type":"object",
					"properties":{
						"email":{
							"type":"string",
							"title":"Email"
						},
						"aad_token":{
							"type":"string",
							"title":"AAD Token"
						},
						"private_key_val":{
							"type":"string",
							"title":"Private Key Val"
						},
						"fingerprint":{
							"type":"string",
							"title":"Fingerprint Of Cert"
						},
						"issuer":{
							"type":"string",
							"title":"Public Key Issuer"
						},
						"virtusa_people_sub_key":{
							"type":"string",
							"title":"Virtusa People Sub Key"
						},
						"worker_api_url":{
							"type":"string",
							"title":"Worker Api Url"
						},
						"apim_server":{
							"type":"string",
							"title":"Apim Server"
						}
					},
					"additionalProperties":false,
					"required":[
						"email",
						"aad_token",
						"private_key_val",
						"fingerprint",
						"issuer",
						"virtusa_people_sub_key",
						"worker_api_url",
						"apim_server"
					]
				},
				"imports":[
					"python-jose",
					"cryptography ",
					"requests",
					"pyjwt"
				],
				"code":"import base64\nimport requests\nimport jwt\nimport datetime\nfrom datetime import UTC\nfrom urllib.parse import quote\nfrom cryptography.hazmat.primitives import serialization\nfrom cryptography.hazmat.backends import default_backend\nfrom urllib.parse import urlencode\n\n\n\nprivate_key_val =  \"MIICXgIBAAKBgQCv4PFGSYCWixLZqzm7yMPfcibclCyFFynxk1ps59th2EAQ64N72tIvT97tVFbxMG2jQbx9rsbq3oBNXGeErPxqNFjaAd7Kgz9AsaUSP4Lu9dH0cfLkZcDHF7FzbMlLOm3dqvCVdEjuSmXFae22d/A0yJo+U3hqXhgsyduWs3o3lwIDAQABAoGAGCqTXHILDiRr4abKVwgeCdzYhCSD/YGSTNRPb3loRoh9PRXvShxmFwQlgHy/OYLK/cyxhp92S51pCbgxrSRLxl2L3GsaIbqQjyvF2tBGVzZXAGVWNWHzN8CnX4NunGC26eBKir6uTy45Knz8nPr0KLyQfdEmfuLLHrKqt42gfHECQQDmIDA3SSOBIylYzVoporzQgBranmLRLN2BoTbOLNiaNW8RR/8i4kAoEroZ9GzVQuBG7UvV56hi+BJnoM//cGvpAkEAw6dWRN52hID2rE716gGHYksI272daFNjSvrTRL6f2LpyqOJo98rd4QrX90YEexm1fApLy4lO806vA8cfRvTXfwJBAJKx+Cp1/CUI9gV+ujgKXlSHJRcxmgp/kCBfVWFuoxECeO/KNnDVS1KARZPgBTSZMgDkqdAMoYGdY5YdpBnQX2kCQQC0IfJpQbA4WkvBZIlAQtwUgSTMuwybKnr2Y2vzlNWyQiaimqEt0lbphIRFou8pLwhKBWi3IdnQZJb5kXCYcX+dAkEAm4r5wSbnjeXcaasO1X11FO3oRwgin459ODArpdJKVPZzKCjtffjRzCAw40z/GyPg9Hf7AL6gh12TWsXq32OK3g==\"\nfingerprint_of_cert =  \"2GUBJFWrAl8qiu/UkKhAlkzGDY0=\"\npublic_key_issuer =  \"www.mycompany.com\"\n\ndef get_person_number_from_email(email, aad_token):\n    filter_value = f\"(upper(emails.EmailAddress)='{email.upper()}') and (emails.EmailType='W1')\"\n    encoded_filter = quote(filter_value)\n    base_url = \"https://virtueagintegrationsapim-dev2.azure-api.net/v5-workers-api/v1/workers\"\n    query_param = f\"?q={encoded_filter}&expand=emails&onlyData=true\"\n    full_url = base_url + query_param\n    headers = {\n        \"Ocp-Apim-Subscription-Key\": \"964bfe179cbb4aeb8fa4e7ae80461974\",\n        \"REST-Framework-Version\": \"4\",\n        \"Authorization\": f\"Bearer {aad_token}\"\n    }\n\n    response = requests.get(full_url, headers=headers)\n    if response.status_code == 200:\n        data = response.json()\n        items = data.get(\"items\", [])\n        if items:\n            return items[0].get(\"PersonNumber\")\n    else:\n        return {\"API Error\": response.text}\n\n    return {\"error\" : \"api error\"}\n\n\ndef get_person_number_from_token_email(jwt_token):\n    try:\n        decoded_token = jwt.decode(jwt_token, options={\"verify_signature\": False})\n        upn = decoded_token.get(\"upn\")\n        if not upn:\n            print(\"error\", \"not get upn\")\n            return None\n        return get_person_number_from_email(upn, jwt_token)\n    except Exception as e:\n        return None\n\ndef generate_jwt_token_for_fusion(private_key_val, fingerprint_cert_base64, issuer, aad_token):\n    person_number = get_person_number_from_token_email(aad_token)\n    if not person_number or isinstance(person_number, dict):\n        print(\"Person number not found or error:\", person_number)\n        return None\n\n    try:\n        # If the private key is in DER base64 format\n        private_key_bytes = base64.b64decode(private_key_val)\n        private_key = serialization.load_der_private_key(\n            private_key_bytes, password=None, backend=default_backend())\n\n        # now = datetime.datetime.utcnow()\n        now = datetime.datetime.now(UTC)\n        payload = {\n            \"iss\": issuer,\n            \"prn\": person_number,\n            \"iat\": int(now.timestamp()),  \n            \"exp\": int((now + datetime.timedelta(hours=1)).timestamp())\n        }\n\n        headers = {\n            \"typ\": \"JWT\",\n            \"alg\": \"RS256\",\n            \"x5t\": fingerprint_of_cert  # Use raw if already base64url encoded\n        }\n\n        token = jwt.encode(\n            payload,\n            private_key,\n            algorithm=\"RS256\",\n            headers=headers\n        )\n\n        return token\n\n    except Exception as e:\n        print(\"Error generating JWT:\", e)\n        return None\n\nresult = generate_jwt_token_for_fusion(private_key_val, fingerprint_of_cert, public_key_issuer, aad_token)\nprint(result)\n\n\n",
				"isAsync":false,
				"python_version":"3.12",
				"parameters":{
					"email":"{{ n_cDeDe.outputs.email }}",
					"aad_token":"{{ n_cDeDe.outputs.AADToken }}",
					"fingerprint":"{{ __ENV__.outputs.FINGERPRINT_PRINT_OF_CERT }}",
					"issuer":"{{ __ENV__.outputs.PUBLIC_KEY_ISSUER }}",
					"virtusa_people_sub_key":"{{ __ENV__.outputs.virtusaPeopleSubkey }}",
					"worker_api_url":"{{ __ENV__.outputs.worker-api-url }}",
					"apim_server":"{{ __ENV__.outputs.apim-server }}",
					"private_key_val":"{{ __ENV__.outputs.PRIVATE_KEY_JWT_TOKEN_EMAIL }}"
				}
			},
			"skip":false,
			"subTitle":"Code",
			"title":"Execute Python script",
			"type":"ACTION"
		},
		{
			"context":{
				"appName":"callables",
				"resourceVersion":797,
				"resourceName":"callables_return_to_automation",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":false,
			"fallbackMode":"STOP",
			"groupId":"_UX8oT-1",
			"id":"n_AvNAu",
			"index":3,
			"inputs":{
				"result":{
					"result":"{{ n_Lj2kG.outputs.result }}"
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Respond to automation",
			"type":"STOP"
		}
	],
	"ownerUserId":142214,
	"projectId":1927,
	"schemaReferences":[
		
	],
	"settings":{
		"enableNodeLevelLogging":true,
		"enableRunLogging":true,
		"enableVariableLogging":true
	},
	"standard":false,
	"tags":[
		
	],
	"version":41
}